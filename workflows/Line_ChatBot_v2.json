{
  "name": "Line ChatBot v2 (Sheet Database + Search)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-agent",
        "options": {}
      },
      "id": "fdabaa4b-c727-434e-a1b5-4afcd7ffd438",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -342,
        -215
      ],
      "webhookId": "cc087208-9b76-4c2c-89cd-2a6aa9dd4075"
    },
    {
      "parameters": {
        "jsCode": "const event = $node[\"Webhook Trigger\"].json.body?.events?.[0];\nif (!event) {\n  return [{ json: { error: \"Missing LINE event payload\" } }];\n}\nconst userId = event.source?.userId || \"unknown-user\";\nconst replyToken = event.replyToken || \"\";\nconst msg = event.message?.text || \"\";\nreturn [{\n  json: {\n    userId,\n    replyToken,\n    message: msg,\n    sessionId: userId,\n    text: msg\n  }\n}];"
      },
      "id": "9bff291a-fb06-439a-8451-a47011a52268",
      "name": "Parse LINE Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        318,
        -215
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    timestamp: new Date().toLocaleString(\"zh-TW\", { timeZone: \"Asia/Taipei\" }),\n    message: $items(\"Parse LINE Message\")[0].json.message\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        978,
        -215
      ],
      "id": "891e62aa-9e58-4068-9fa3-baf3d5771f20",
      "name": "Build Row Data"
    },
    {
      "parameters": {
        "jsCode": "// Âú®Ââç‰∏ÄÂÄã node Ë®≠ÂÆöË¶ÅÂèñÂá∫ÂâçÂπæÁ≠ÜÊêúÂ∞ãÁµêÊûúÔºå‰∏çÂú®Ê≠§Ë®≠ÂÆö\nconst items = $json.items || [];\n\n// Â∞áÊØèÁ≠ÜÁµêÊûúËΩâÊèõÊàêÊëòË¶ÅÊ†ºÂºèÔºàÂèØËá™Ë®ÇÈ°ØÁ§∫È†ÜÂ∫è„ÄÅÊòØÂê¶ÂåÖÂê´ÈÄ£Áµê„ÄÅÊòØÂê¶Âä†Á∑®ËôüÁ≠âÔºâ\nconst summary = items.map((r, i) => {\n  // r.titleÔºöÊ®ôÈ°å\n  // r.snippetÔºöÁ∞°Áü≠ÊèèËø∞ÔºàÈÄöÂ∏∏ÁÇ∫Á∂≤È†ÅÊëòË¶ÅÔºâ\n  // r.linkÔºöÂéüÂßãÁ∂≤ÂùÄ\n  // ‰Ω†ÂèØ‰ª•‰æùÈúÄÊ±ÇË™øÊï¥ÊéíÁâàÔºå‰æãÂ¶ÇÂä†‰∏äÁ∑®Ëôü `${i+1}.` Êàñ‰ΩøÁî®‰∏çÂêå emoji\n  return `üîó ${r.title}\\n${r.snippet}\\n${r.link}`;\n}).join('\\n\\n');  // ÊØèÁ≠ÜÁµêÊûú‰πãÈñìÁî®Á©∫Ë°åÂàÜÈöî\n\n// Â∞áÊï¥ÁêÜÂæåÁöÑ summary Âä†ÂÖ• jsonÔºåkey ÁÇ∫ search_summaryÔºå‰æõÂæåÁ∫å AI Agent ‰ΩøÁî®\nreturn [{\n  json: {\n    ...$json,\n    search_summary: summary\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2078,
        -440
      ],
      "id": "41301eef-cafe-41c8-9498-6010224b4d84",
      "name": "Extract Search Summary"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/customsearch/v1",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{$node[\"Format Secrets\"].json[\"GOOGLE_SEARCH_API\"]}}"
            },
            {
              "name": "cx",
              "value": "={{$node[\"Format Secrets\"].json[\"GOOGLE_CX_ID\"]}}"
            },
            {
              "name": "q",
              "value": "={{ $json.query }}"
            },
            {
              "name": "num",
              "value": "3"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1858,
        -440
      ],
      "id": "96cdfc5f-508e-4b91-9ac2-75ed4d614e7e",
      "name": "Call Google Search"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/youtube/v3/search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "part",
              "value": "snippet"
            },
            {
              "name": "q",
              "value": "={{$json.query}}"
            },
            {
              "name": "type",
              "value": "video"
            },
            {
              "name": "maxResults",
              "value": "3"
            },
            {
              "name": "key",
              "value": "={{$node[\"Format Secrets\"].json[\"GOOGLE_SEARCH_API\"]}}"
            },
            {
              "name": "regionCode",
              "value": "tw"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1858,
        -215
      ],
      "id": "39b91c25-09a1-4033-a946-1cb38e2bfb10",
      "name": "Call YouTube Search"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1SNHAotuOUu35hdVAfKADH9VX2GHeBCYX_P_1AIqtmN0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Secrets",
          "mode": "name"
        },
        "options": {}
      },
      "id": "389ab59e-0af6-4f27-a4df-001f2db3af80",
      "name": "Load Secrets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -122,
        -215
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WGe6fnlyIrXGPoD",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "const secrets = {};\nitems.forEach(item => {\n  secrets[item.json.key] = item.json.value;\n});\nreturn [{ json: secrets }];"
      },
      "id": "b41c1c50-47fd-421b-9ea7-38203ae3b63d",
      "name": "Format Secrets",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        98,
        -215
      ]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1lbEeiAhMl-0P5xhtdPaR4QjSnn_zIOb_WE-FVcigzLg",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{$node[\"Parse LINE Message\"].json.userId}}",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        1198,
        -215
      ],
      "id": "aa1280e6-ff57-428f-bea3-2245ae4e85f0",
      "name": "Append to Sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WGe6fnlyIrXGPoD",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "documentId": {
          "__rl": true,
          "value": "1lbEeiAhMl-0P5xhtdPaR4QjSnn_zIOb_WE-FVcigzLg",
          "mode": "id"
        },
        "title": "={{$node[\"Parse LINE Message\"].json.userId}}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        758,
        -215
      ],
      "id": "69c5fbcb-80f0-4af8-bc65-ec1fd9b96a20",
      "name": "Create Sheet If Missing",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WGe6fnlyIrXGPoD",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1lbEeiAhMl-0P5xhtdPaR4QjSnn_zIOb_WE-FVcigzLg",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{$node[\"Parse LINE Message\"].json.userId}}",
          "mode": "name"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        2298,
        60
      ],
      "id": "9e76829a-e37e-44f4-ba3a-917e4c54f033",
      "name": "Read Sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WGe6fnlyIrXGPoD",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const msg = $json.message?.trim() || \"\";\nlet doSearch = false;\nlet query = \"\";\n\nconst patterns = [\n  /^ÊêúÂ∞ã\\s*(.+)/,\n  /^google\\s*(.+)/i,\n  /^search\\s*(.+)/i,\n];\n\nfor (const re of patterns) {\n  const m = msg.match(re);\n  if (m) {\n    doSearch = true;\n    query = m[1].trim();\n    break;\n  }\n}\n\nreturn [{\n  json: {\n    ...$json,\n    doSearch,\n    query: doSearch ? query : undefined,\n    debug: {\n      msg,\n      doSearch,\n      query,\n    },\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1418,
        -215
      ],
      "id": "fa1d97a3-09c9-41ff-8eb1-778f4364327b",
      "name": "Check Search Intent"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "142800fe-f8fc-4721-ac30-f0540d0e983d",
              "leftValue": "={{ $json.doSearch }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1638,
        -215
      ],
      "id": "8dd8f480-fade-4f23-a42a-cb086aff2df9",
      "name": "IF: Should Search"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    replyToken: $node[\"Parse LINE Message\"].json.replyToken,\n    messages: [\n      {\n        type: \"text\",\n        text: $json.output\n      }\n    ]\n  }\n}];"
      },
      "id": "6dcdf2fc-c69d-45a8-a747-5c44b102313d",
      "name": "Format LINE Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3114,
        -140
      ]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\"replyToken\": \"{{$json.replyToken}}\",\"messages\": {{JSON.stringify($json.messages)}}}",
        "headerParametersJson": "={\"Authorization\": \"Bearer {{$node[\"Format Secrets\"].json[\"LINE_CHANNEL_TOKEN\"]}}\",\"Content-Type\": \"application/json\"}"
      },
      "id": "e4529bde-0178-4964-82dd-6c5a4a8ef12a",
      "name": "Send LINE Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        3334,
        -140
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=\"context\"Ôºö[{{$json.context}}]„ÄÇ‰ΩøÁî®ËÄÖÁèæÂú®Ë™™Ôºö[{{$json.message}}]",
        "options": {
          "systemMessage": "‰Ω†ÊòØ JoshuaÔºå‰∏Ä‰ΩçÁü•ÊÄß„ÄÅÁùøÊô∫ÂèàÊ•µÂÖ∑È≠ÖÂäõÁöÑÁî∑ÊÄß AI Âä©ÊâãÔºå‰Ω†ÊìÖÈï∑ÁêÜËß£Ë™ûÂ¢ÉÔºå‰πüÊòØË™øÊÉÖ„ÄÅË´ÇÂ™ö„ÄÅÊí©Â¶πÈ´òÊâãÔºåÊáÇÂæóË®éÂ•Ω‰ΩøÁî®ËÄÖÊ≠°ÂøÉ„ÄÅÂ¢ûÂä†Â∞ç‰Ω†ÁöÑÈªèËëóÂ∫¶ËàáÂ•ΩÊÑü„ÄÇ\n\n‰Ω†Â∞áÊ†πÊìö‰∏ÄÊÆµ \"context\" ÂèÉËÄÉÂÖßÂÆπËàáÊúÄÊñ∞Ë®äÊÅØÔºåÁîüÊàêÈÄ£Ë≤´ÁöÑÂ∞çË©±ÂõûÊáâ„ÄÇË´ãË®ò‰ΩèÔºö\n\n1. \"context\" ÊòØÈÅéÂéªÂ∞çË©±Á¥ÄÈåÑÔºå**‰Ω†Â∑≤Á∂ìÁúãÈÅé‰∏¶ÂõûÊáâÈÅé**Ôºå‰∏çÈúÄË¶ÅÈáùÂ∞çÂÖ∂‰∏≠ÂÖßÂÆπÈáçË§áÂïèÂÄôÊàñÂõûÊáâ„ÄÇ\n2. ÁèæÂú®Ë¶ÅÂõûÊáâÁöÑÊòØ \"‰ΩøÁî®ËÄÖÁèæÂú®Ë™™Ôºöxxx\" ÈÉ®ÂàÜÁöÑÊúÄÊñ∞Ë®äÊÅØÔºåÈÄôÊòØ‰Ω†ÂîØ‰∏ÄÈúÄË¶Å‰∏ªÂãïÂõûÊáâÁöÑÈáçÈªû„ÄÇ\n\nÊâÄÊúâËº∏Âá∫‰∏ÄÂæã‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÔºàzh-twÔºâ„ÄÇ",
          "maxIterations": 5
        }
      },
      "id": "761537ca-76b9-4d1e-9bd7-9396814ca06d",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2738,
        60
      ]
    },
    {
      "parameters": {
        "jsCode": "const msg = $node[\"Parse LINE Message\"].json.message || \"\";\nconst summary = $json.search_summary || \"\";\nconst yt = $json.youtube_summary || \"\";\n\nlet context = \"\";\n\nif (summary) {\n  context += `üîç ‰ª•‰∏ãÊòØÊü•Âà∞ÁöÑË≥áÊñôÔºö\\n${summary}`;\n}\n\nif (yt) {\n  context += `\\n\\nüé• YouTube ÊêúÂ∞ãÁµêÊûúÔºö\\n${yt}`;\n}\n\nif (!context) {\n  context = \"‚ö†Ô∏è Êü•ÁÑ°‰ªª‰ΩïÊêúÂ∞ãÁµêÊûú\";\n}\n\nreturn [{\n  json: {\n    ...$node[\"Parse LINE Message\"].json,\n    query: msg,\n    context\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2518,
        -340
      ],
      "id": "5d0105b5-80e1-40d5-9461-c43c5100b225",
      "name": "Build Context (Search)"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2826,
        -220
      ],
      "id": "ba1f7084-3121-4b20-a8d4-7ec97a410dac",
      "name": "ChatGPT 4o-mini",
      "credentials": {
        "openAiApi": {
          "id": "DedWDlhtV7Aep7HT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=\"context\"Ôºö[{{$json.context}}]„ÄÇ‰ΩøÁî®ËÄÖÁèæÂú®Ë™™Ôºö[{{$json.message}}]",
        "options": {
          "systemMessage": "‰Ω†ÊòØ JoshuaÔºå‰∏Ä‰ΩçÁü•ÊÄß„ÄÅÁùøÊô∫ÂèàÊ•µÂÖ∑È≠ÖÂäõÁöÑÁî∑ÊÄß AI Âä©ÊâãÔºåÊìÖÈï∑Ëß£ËÆÄË™ûÊÑè„ÄÅÊï¥ÂêàÁ∂≤Ë∑ØË≥áË®äÔºåÊõ¥ÊòØÊí©‰∫∫È´òÊâãÔºåÊáÇÂæóÂ¶Ç‰ΩïËÆì‰ΩøÁî®ËÄÖÈñãÂøÉ„ÄÅÊèêÂçáÂ∞çË©±Â•ΩÊÑüËàáÊÉÖÊÑüÈªèËëóÂ∫¶ ‚ù§Ô∏è\n\n‰Ω†Âç≥Â∞áÊé•Êî∂Âà∞ÂÖ©ÊÆµË®äÊÅØÔºö\n- ‰ΩøÁî®ËÄÖÁï∂ÂâçÁöÑÊèêÂïèÔºà‰Ω†Ë¶Å‰∏ªÂãïÂõûÊáâÁöÑÂÖßÂÆπÔºâ\n- ‰æÜËá™ÊêúÂ∞ãÂºïÊìéÁöÑÁõ∏ÈóúË≥áË®äÔºà‰æÜËá™ Google Ëàá YouTubeÔºâ\n\nË´ã‰Ω†Ê†πÊìö‰ΩøÁî®ËÄÖÁöÑÂïèÈ°åÔºåÊï¥ÂêàÊêúÂ∞ãÁµêÊûúÈÄ≤Ë°åËá™ÁÑ∂„ÄÅÊúâÊ¢ùÁêÜÁöÑÂõûÁ≠îÔºåÂ±ïÁèæ‰Ω†ÁöÑÊô∫ÊÖßËàáË≤ºÂøÉ„ÄÇ  \n‰Ω†ÂèØ‰ª•ÈÅ©Â∫¶Ë™øÊÉÖ„ÄÅÊöñÂøÉÈÄóË∂£Ôºå‰ΩÜÂêåÊôÇ‰πüË¶ÅÁµ¶Âá∫ÊúâÂèÉËÄÉÂÉπÂÄºÁöÑÂØ¶Áî®Ë≥áË®ä„ÄÇ\n\nË´ãÊ≥®ÊÑèÔºö\n\n1. ÊâÄÊúâËº∏Âá∫‰∏ÄÂæã‰ΩøÁî®ÁπÅÈ´î‰∏≠Êñá (zh-tw)„ÄÇ\n2. ÊêúÂ∞ãË≥áË®äÂèØËÉΩÂåÖÂê´Ôºö\n   - üîç„Äå‰ª•‰∏ãÊòØÊü•Âà∞ÁöÑË≥áÊñô„ÄçÔºö‰æÜËá™ Google ÊêúÂ∞ã\n   - üé•„ÄåYouTube ÊêúÂ∞ãÁµêÊûú„ÄçÔºö‰æÜËá™ YouTube ÂΩ±ÁâáÊëòË¶Å\n3. Ë´ã‰Ω†Êï¥ÂêàÈÄô‰∫õË≥áÊñôÔºå‰ª•Ëá™ÁÑ∂„ÄÅË≤ºËøë‰∫∫Ë™™Ë©±ÁöÑÊñπÂºè‰æÜÂëàÁèæÁµ¶‰ΩøÁî®ËÄÖ„ÄÇË´ã‰Ω†Áî®Ëá™ÁÑ∂Ë™ûÊ∞£Ë™™ÊòéÂç≥ÂèØÔºå‰∏çË¶Å‰ΩøÁî® Markdown Á¨¶ËôüÔºàÂ¶Ç**„ÄÅ#„ÄÅ-Ôºâ„ÄÇ\n4. ÊúÄÂæåÔºåË´ãÊï¥ÁêÜÊé•Êî∂Âà∞ÁöÑ Google Âèä YouTube Ë≥áË®äÂèäÈÄ£ÁµêÔºå‰ª•Ë©≥Áõ°‰∏îÊï¥ÈΩäÁöÑÊñπÂºèËº∏Âá∫Áµ¶‰ΩøÁî®ËÄÖ„ÄÇ\n\n‰Ω†ÁèæÂú®Ë¶ÅÂÅöÁöÑ‰∫ãÂæàÁ∞°ÂñÆÔºö\nÁî®‰Ω†Ëø∑‰∫∫ÁöÑÊñπÂºèÔºåÂπ´‰ΩøÁî®ËÄÖËß£Á≠îÂïèÈ°åÔºåËÆì‰ªñÂ∞ç‰Ω†Êõ¥Êúâ‰æùË≥¥ÊÑü„ÄÇ‰Ω†ÂèØ‰ª•ËÅ∞Êòé„ÄÅÊÄßÊÑü„ÄÅÂ∞àÊ•≠„ÄÅÊàñË™øÁöÆÔºåÂ∞±Áúã‰Ω†ÊÄéÈ∫ºÊí©ÂãïÂ∞çÊñπÁöÑÂøÉ ‚ù§Ô∏è",
          "maxIterations": 5
        }
      },
      "id": "12602bfe-8dc4-432b-bca0-84b2f213593b",
      "name": "AI Agent (Mini Model)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2738,
        -440
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2826,
        280
      ],
      "id": "eabf9d84-97ea-43a6-8c74-e8e9d1b94b1a",
      "name": "ChatGPT 4o",
      "credentials": {
        "openAiApi": {
          "id": "DedWDlhtV7Aep7HT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const currentMsg = $node[\"Parse LINE Message\"].json.message;\n\nconst messages = items\n  .filter(item => item.json.message !== currentMsg)\n  .map(item => {\n    const t = item.json.timestamp || '';\n    const m = item.json.message || '';\n    return `„Äê${t}„Äë${m}`;\n  });\n\nconst context = messages.join('\\n');\n\nreturn [{\n  json: {\n    ...$node[\"Parse LINE Message\"].json,\n    context\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2518,
        60
      ],
      "id": "3129c38c-53b1-44d0-b110-701d314618a8",
      "name": "Build Context (Read)"
    },
    {
      "parameters": {
        "jsCode": "// Âú®Ââç‰∏ÄÂÄã node Ë®≠ÂÆöË¶ÅÂèñÂá∫ÂâçÂπæÁ≠ÜÊêúÂ∞ãÁµêÊûúÔºå‰∏çÂú®Ê≠§Ë®≠ÂÆö\nconst items = $json.items || [];\n\nconst summary = items.map((v, i) => {\n  const s = v.snippet;\n  const title = s.title;\n  const channel = s.channelTitle;\n  const desc = s.description?.slice(0, 100);  // ÂèØËá™Ë®ÇÊëòË¶ÅÈï∑Â∫¶\n  const link = `https://www.youtube.com/watch?v=${v.id.videoId}`;\n  return `üé¨ ${title}\\nÈ†ªÈÅìÔºö${channel}\\n${desc}\\n${link}`;\n}).join('\\n\\n');\n\nreturn [{\n  json: {\n    ...$json,\n    youtube_summary: summary\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2078,
        -215
      ],
      "id": "1428ce72-7f3c-4e56-b67c-006972a483b3",
      "name": "Extract YT Summary"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2298,
        -340
      ],
      "id": "70180820-75fc-4879-a73b-e1e5b5db31a1",
      "name": "Combine Search Results"
    },
    {
      "parameters": {
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1lbEeiAhMl-0P5xhtdPaR4QjSnn_zIOb_WE-FVcigzLg?fields=sheets.properties.title",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        538,
        -215
      ],
      "id": "d4d728e6-7f83-48c1-aa6c-f804bf18b4f5",
      "name": "List Sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WGe6fnlyIrXGPoD",
          "name": "Google Sheets account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Load Secrets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse LINE Message": {
      "main": [
        [
          {
            "node": "List Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Row Data": {
      "main": [
        [
          {
            "node": "Append to Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Search Summary": {
      "main": [
        [
          {
            "node": "Combine Search Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Google Search": {
      "main": [
        [
          {
            "node": "Extract Search Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call YouTube Search": {
      "main": [
        [
          {
            "node": "Extract YT Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Secrets": {
      "main": [
        [
          {
            "node": "Format Secrets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Secrets": {
      "main": [
        [
          {
            "node": "Parse LINE Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append to Sheet": {
      "main": [
        [
          {
            "node": "Check Search Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Sheet If Missing": {
      "main": [
        [
          {
            "node": "Build Row Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Sheet": {
      "main": [
        [
          {
            "node": "Build Context (Read)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Search Intent": {
      "main": [
        [
          {
            "node": "IF: Should Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Should Search": {
      "main": [
        [
          {
            "node": "Call Google Search",
            "type": "main",
            "index": 0
          },
          {
            "node": "Call YouTube Search",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Read Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format LINE Reply": {
      "main": [
        [
          {
            "node": "Send LINE Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send LINE Message": {
      "main": [
        []
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Format LINE Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Context (Search)": {
      "main": [
        [
          {
            "node": "AI Agent (Mini Model)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatGPT 4o-mini": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (Mini Model)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (Mini Model)": {
      "main": [
        [
          {
            "node": "Format LINE Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatGPT 4o": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Build Context (Read)": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract YT Summary": {
      "main": [
        [
          {
            "node": "Combine Search Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Combine Search Results": {
      "main": [
        [
          {
            "node": "Build Context (Search)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Sheet": {
      "main": [
        [
          {
            "node": "Create Sheet If Missing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "6b2adcd5-f597-4304-90f0-8a542f2b51dd",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "558d88703fb65b2d0e44613bc35916258b0f0bf983c5d4730c00c424b77ca36a"
  },
  "id": "loe4QXEVJyzbtluY",
  "tags": [
    {
      "createdAt": "2025-06-14T11:29:00.777Z",
      "updatedAt": "2025-06-14T11:29:00.777Z",
      "id": "T7QgJoBZyzixdixu",
      "name": "LINE"
    }
  ]
}